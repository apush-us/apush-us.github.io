!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CirclePacker=t()}(this,function(){"use strict";function e(e,t){e.postMessage(JSON.stringify(t))}function t(e){return e.data?JSON.parse(e.data):{}}function i(e){return e&&e.id&&e.radius&&e.position&&"number"==typeof e.position.x&&"number"==typeof e.position.y}function o(e){return e&&"number"==typeof e.width&&"number"==typeof e.height}var r=function(e){void 0===e&&(e={}),this.worker=new Worker(URL.createObjectURL(new Blob(['function sendWorkerMessage(e,i){e.postMessage(JSON.stringify(i))}function processWorkerMessage(e){return e.data?JSON.parse(e.data):{}}function receivedMessage(e){var i=processWorkerMessage(e),t=i.type,r=i.message;"bounds"===t&&circleManager.setBounds(r),"target"===t&&setTarget(r),"addcircles"===t&&addCircles(r),"removecircle"===t&&circleManager.removeCircle(r),"update"===t&&update(),"dragstart"===t&&circleManager.dragStart(r.id,r.position),"drag"===t&&circleManager.drag(r.id,r.position),"dragend"===t&&circleManager.dragEnd(r.id),"centeringpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCenteringPasses=r),"collisionpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCollisionPasses=r),"damping"===t&&"number"==typeof r&&r>0&&(circleManager.damping=r)}function updatePage(e,i){sendWorkerMessage(self,{type:e,message:i})}function addCircles(e){Array.isArray(e)&&e.length&&e.forEach(circleManager.addCircle.bind(circleManager))}function setTarget(e){e&&"number"==typeof e.x&&"number"==typeof e.y&&circleManager.setTarget(new Vector(e))}function update(){circleManager.updatePositions(),sendPositions()}function sendPositions(){var e=circleManager.allCircles.reduce(function(e,i){return e[i.id]={position:i.position,previousPosition:i.previousPosition,radius:i.radius,delta:i.delta},e},{});updatePage("move",e)}var Vector=function(e,i){"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i)};Vector.prototype.cp=function(){return new Vector(this.x,this.y)},Vector.prototype.mul=function(e){return this.x*=e,this.y*=e,this},Vector.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,this},Vector.prototype.length=function e(){var e=Math.sqrt(this.x*this.x+this.y*this.y);return e<.005&&e>-.005?1e-6:e},Vector.prototype.distance=function(e){var i=this.x-e.x,t=this.y-e.y;return Math.sqrt(i*i+t*t)},Vector.prototype.distanceSquared=function(e){var i=this.x-e.x,t=this.y-e.y;return i*i+t*t};var PackedCircle=function(e,i,t,r){void 0===t&&(t=0),void 0===r&&(r=0),this.id=e,this.targetPosition=new Vector(0,0),this.position=new Vector(t,r),this.previousPosition=new Vector(t,r),this.positionWithOffset=new Vector(t,r),this.previousPositionWithOffset=new Vector(t,r),this.setRadius(i)},prototypeAccessors={delta:{}};PackedCircle.prototype.setPosition=function(e){this.previousPosition=this.position,this.position=e.cp()},PackedCircle.prototype.distanceSquaredFromTargetPosition=function(){var e=this.position.distanceSquared(this.targetPosition);return e<this.radiusSquared},PackedCircle.prototype.setRadius=function(e){this.radius=e,this.radiusSquared=e*e,this.originalRadius=e},prototypeAccessors.delta.get=function(){return new Vector(this.position.x-this.previousPosition.x,this.position.y-this.previousPosition.y)},Object.defineProperties(PackedCircle.prototype,prototypeAccessors);var PackedCircleManager=function(){this.allCircles=[],this.desiredTarget=new Vector(0,0),this.bounds={left:0,top:0,right:0,bottom:0},this.damping=.025,this.numberOfCenteringPasses=1,this.numberOfCollisionPasses=3};PackedCircleManager.prototype.setBounds=function(e){"number"==typeof e.left&&(this.bounds.left=e.left),"number"==typeof e.right&&(this.bounds.right=e.right),"number"==typeof e.top&&(this.bounds.top=e.top),"number"==typeof e.bottom&&(this.bounds.bottom=e.bottom),"number"==typeof e.width&&(this.bounds.right=this.bounds.left+e.width),"number"==typeof e.height&&(this.bounds.bottom=this.bounds.top+e.height)},PackedCircleManager.prototype.addCircle=function(e){e instanceof PackedCircle||(e=new PackedCircle(e.id,e.radius,e.position.x,e.position.y)),this.allCircles.push(e),e.targetPosition=this.desiredTarget.cp()},PackedCircleManager.prototype.removeCircle=function(e){for(var i=this,t=this.allCircles.reduce(function(i,t,r){return t.id===e&&i.push(r),i},[]),r=t.length-1;r>=0;r--)i.allCircles.splice(t[r],1)},PackedCircleManager.prototype.updatePositions=function(){for(var e=this,i=this.allCircles,t=i.length,r=0;r<t;++r){var o=i[r];o.previousPosition=o.position.cp()}this.desiredTarget&&this.pushAllCirclesTowardTarget(this.desiredTarget),this.handleCollisions();for(var s=0;s<t;++s){var n=i[s];e.handleBoundaryForCircle(n)}},PackedCircleManager.prototype.pushAllCirclesTowardTarget=function(e){for(var i=this,t=new Vector(0,0),r=this.draggedCircle,o=this.allCircles,s=o.length,n=0;n<this.numberOfCenteringPasses;n++)for(var a=0;a<s;a++){var c=o[a];c!==r&&(t.x=c.position.x-e.x,t.y=c.position.y-e.y,t.mul(i.damping),c.position.x-=t.x,c.position.y-=t.y)}},PackedCircleManager.prototype.handleCollisions=function(){for(var e=new Vector(0,0),i=this.draggedCircle,t=this.allCircles,r=t.length,o=0;o<this.numberOfCollisionPasses;o++)for(var s=0;s<r;s++)for(var n=t[s],a=s+1;a<r;a++){var c=t[a];if(n!==c){var d=c.position.x-n.position.x,l=c.position.y-n.position.y,p=1.08*(n.radius+c.radius),u=n.position.distanceSquared(c.position);if(u<p*p-.02){e.x=d,e.y=l,e.normalize();var h=.5*(p-Math.sqrt(u));e.mul(h),c!==i&&(n===i&&e.mul(2.2),c.position.x+=e.x,c.position.y+=e.y),n!==i&&(c===i&&e.mul(2.2),n.position.x-=e.x,n.position.y-=e.y)}}}},PackedCircleManager.prototype.handleBoundaryForCircle=function(e){var i=e.position.x,t=e.position.y,r=e.radius,o=!1;i+r>=this.bounds.right?(e.position.x=this.bounds.right-r,o=!0):i-r<this.bounds.left&&(e.position.x=this.bounds.left+r,o=!0),t+r>this.bounds.bottom?(e.position.y=this.bounds.bottom-r,o=!0):t-r<this.bounds.top&&(e.position.y=this.bounds.top+r,o=!0),o&&e===this.draggedCircle&&(this.draggedCircle=null)},PackedCircleManager.prototype.setDraggedCircle=function(e){this.draggedCircle&&this.draggedCircle!==e&&(this.draggedCircle.radius=this.draggedCircle.originalRadius),this.draggedCircle=e},PackedCircleManager.prototype.dragStart=function(e){var i=this.allCircles.filter(function(i){return i.id===e})[0];this.setDraggedCircle(i)},PackedCircleManager.prototype.dragEnd=function(e){this.draggedCircle&&this.setDraggedCircle(null)},PackedCircleManager.prototype.drag=function(e,i){this.draggedCircle&&i&&(this.draggedCircle.position.x=i.x,this.draggedCircle.position.y=i.y)},PackedCircleManager.prototype.setTarget=function(e){this.desiredTarget=e},self.addEventListener("message",receivedMessage);var circleManager=new PackedCircleManager;'],{type:"text/javascript"}))),this.worker.addEventListener("message",this.receivedWorkerMessage.bind(this)),this.isContinuousModeActive="boolean"!=typeof e.continuousMode||e.continuousMode,this.onMoveStart=e.onMoveStart||null,this.onMove=e.onMove||null,this.onMoveEnd=e.onMoveEnd||null,e.centeringPasses&&this.setCenteringPasses(e.centeringPasses),e.collisionPasses&&this.setCollisionPasses(e.collisionPasses),this.addCircles(e.circles||[]),this.setBounds(e.bounds||{width:100,height:100}),this.setTarget(e.target||{x:50,y:50}),this.isLooping=!1,this.areItemsMoving=!0,this.animationFrameId=NaN,this.initialized=!0,this.isContinuousModeActive&&this.startLoop()};return r.prototype.receivedWorkerMessage=function(e){var i=t(e);if("move"===i.type){var o=i.message;this.areItemsMoving=this.hasItemMoved(o)}this.updateListeners(i)},r.prototype.updateWorker=function(t,i){e(this.worker,{type:t,message:i})},r.prototype.updateListeners=function(e){var t=e.type,i=e.message;"movestart"===t&&"function"==typeof this.onMoveStart&&this.onMoveStart(i),"move"===t&&"function"==typeof this.onMove&&this.onMove(i),"moveend"===t&&"function"==typeof this.onMoveEnd&&this.onMoveEnd(i)},r.prototype.addCircles=function(e){if(Array.isArray(e)&&e.length){var t=e.filter(i);t.length&&this.updateWorker("addcircles",t)}this.startLoop()},r.prototype.addCircle=function(e){this.addCircles([e])},r.prototype.removeCircle=function(e){e&&(e.id?this.updateWorker("removecircle",e.id):this.updateWorker("removecircle",e),this.startLoop())},r.prototype.setBounds=function(e){o(e)&&(this.updateWorker("bounds",e),this.startLoop())},r.prototype.setTarget=function(e){this.updateWorker("target",e),this.startLoop()},r.prototype.setCenteringPasses=function(e){this.updateWorker("centeringpasses",e)},r.prototype.setCollisionPasses=function(e){this.updateWorker("collisionpasses",e)},r.prototype.setDamping=function(e){this.updateWorker("damping",e)},r.prototype.update=function(){this.updateWorker("update")},r.prototype.dragStart=function(e){this.updateWorker("dragstart",{id:e}),this.startLoop()},r.prototype.drag=function(e,t){this.updateWorker("drag",{id:e,position:t}),this.startLoop()},r.prototype.dragEnd=function(e){this.updateWorker("dragend",{id:e}),this.startLoop()},r.prototype.updateLoop=function(){this.update(),this.isLooping&&(this.areItemsMoving?this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)):this.stopLoop())},r.prototype.startLoop=function(){!this.isLooping&&this.initialized&&this.isContinuousModeActive&&(this.isLooping=!0,this.isContinuousModeActive&&(this.areItemsMoving=!0),this.updateListeners("movestart"),this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)))},r.prototype.stopLoop=function(){this.isLooping&&(this.isLooping=!1,this.updateListeners("moveend"),cancelAnimationFrame(this.animationFrameId))},r.prototype.hasItemMoved=function(e){var t=!1;for(var i in e)Math.abs(e[i].delta.x)>.005&&Math.abs(e[i].delta.y)>.005&&(t=!0);return t},r.prototype.destroy=function(){this.worker&&this.worker.terminate(),this.stopLoop(),this.onMove=null,this.onMoveStart=null,this.onMoveEnd=null},r});